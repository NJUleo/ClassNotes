# 并发程序设计

并发进程：运行时的概念。多个程序同时运行，共享资源。

#### 顺序程序

封闭性 顺序型 确定性 可再现性

一旦多个程序并发，这些性质实际就被打破

多级反馈队列算法。抢占式。程序的指令在哪个时间片被分开，是不确定的，程序员无法预测程序在实际运行中的切片。因此，处理器的调度带有随机性，无法预知在哪个时间片切开，无法预知下一次时间片的开始。每两条机器指令之间都是开放的，可能随时被打断。不确定性，多程序并发，计算过程不可再现。

#### 进程的并发性

允许进程在执行时间上重叠。

一个时间段内，几个进程在同一个处理器上，处于运行未结束。

多个进程间，彼此制约和依赖。

#### 并发进程分类

无关：不依赖其他进程，可以独立执行。

交互的并发进程：发生家湖

Bernstein条件：可以同时读，但是不可以有读有写或者都写。

#### 与时间有关的错误

交互的并发进程，受限与处理器调度算法，无法，无法预知相对速度。

* 结果不唯一
* 永远等待

并发下，程序可能创立为多个进程。多个进程之间共享变量

并发程序设计考虑的存在风险，不能按顺序的思维去考虑。

结果不唯一：机票问题

永远等待：申请和归还内存资源问题。主存资源给等待队列，进队列和唤起的冲突

#### 进程的交互：竞争与协作

互斥关系是一种特殊的进程同步关系

同步就是一种等待关系。要跟人同步，就要双方等待。

#### 互斥与临界区

临界资源：共享而互斥的资源

临界区：控制临界资源的程序段。

##### 临界区调度原则

* 一次至多一个进程能够进入临界区内执行
* 如果已有在临界区的进程，则试图进入的其他进程应等待
* 临界区的进程需要在有限时间内退出

信号量PV操作编程，分析临界资源，互斥使用时候，进出得控制结构。并不关心得到临界资源之后怎么做（业务代码）。关心如何获得临界资源以及退出是控制结构如何表达

Peterson 无等待队列，纯软件算法。

信号量PV操作算法，对硬件没有额外要求，具有普世性。

## 信号量与PV操作

### 问题背景

#### 并发程序设计的基本概念

多道程序设计下，系统同时有多个系统加入内存。多个进程就绪。进程之间不满足Bernstein条件的时候，会出现问题。因此，如何管理共享资源的程序，具有潜在冲突的程序。临界资源

串行：系统吞吐率差，时间不能重叠，完全顺序

并发：提高资源利用率，提高吞吐率。并发时，可能造成资源的冲突

##### 临界资源与临界区，同步与互斥

使用变量代表共享资源。

与共享变量有关的代码，叫做临界区 critical section

竞争关系->互斥关系。依赖于前一个进程的结束，等待前一个进程

协调关系->同步关系。

本质上，都是**等待关系**。

##### 临界区管理

简单方法：忙等待/反复测试/Peterson算法

缺点：对不能进入临界区的进程，盲试等待，浪费CPU时间。测试进入临界区的责任，推给了竞争的进程，削弱系统的可靠性，加重用户编程负担

### 基本原理

#### 信号量

信号量：一个进程在某一特殊点上被迫停止执行直到接收到一个对应的特殊变量值。

本质上是一种数据结构。记录型信号量，一个整型value，一个指针指向等待队列。正，则说明有资源。分配时，采用递减的方式进行。负，则说明等待队列的长度

P操作：某个进程请求资源，整型值递减，判断是否为负数。如果小于0，进程转入等待队列。从运行态到等待态，暂时性剥夺进程占用CPU的权利。

原则：同一个时刻最多一个进程在临界区。

V操作：释放资源，整型值加一，如果加完不大于0，说明有等的进程，则归还资源的进程有义务唤醒排队等的进程的第一个。本质上时从等待队列/阻塞队列到就绪队列，赋予占用CPU的权利。

只能通过PV操作对信号量进行处理，不能直接读取和修改。

原语：内核态，关中断的一段程序。

s绝对值：进入P操作，但是没有实际使用，被等待的进程

信号量本质上是数据结构

P代表去请求，可能阻塞也可能不阻塞，进入等待队列有条件

一般纯粹互斥关系，初始信号量为1。一般这中情况下，PV操作再在同一个进程当中。除非是同步关系

### 应用

#### 互斥问题

##### 飞机票问题

剩余票数是共享的，在取得票数之前进入临界区

p操作在if语句之前，v操作在各个else语句当中。要把分支全覆盖。

如果把不相关的同步，会降低性能（不同航班的，放在一个数组当中）。相关的没有同步，则会造成错误。

把不该同步的放开

##### 哲学家就餐问题

P操作本身是原语，但是连续的P操作之间是有缝隙的。可能导致，每个进程都是刚好在第一个P操作之后发生轮转。所有人都占用了右手的叉子，而另一只手的叉子都被占用而等待。所有进程全部进入等待队列，发生死锁。

死锁并不是由于PV操作带来的。而是因为，PV操作的控制结构使用不当。

###### 解法

* 同时至多4个取
* 奇数先左，偶数先右
* 有两把才吃，否则一把叉子也不取。

#### 同步问题

##### 生产者/消费者问题

生产者等待消费者取走产品；消费者等待生产者产生产品。

