# 文件管理

基本的思路是管理磁盘的数据。直接访问磁盘，是层次非常低，难以使用的。

如果没有文件抽象，需要一张巨大的表来存储。同时，磁盘数据的存储保护非常难管理，需要把权限规定细到每一个扇区，因为基本的单位是扇区，表达存储保护的存储开销、读取开销都会变得巨大。因此，构建文件抽象是非常重要的。

构建文件抽象，从此对磁盘的数据使用可以通过“按名使用”的思想，这也是当初设计的重要目标。

文件的概念、文件的命名、分类、优点

#### 文件的概念

文件是具有符号名，逻辑上有完整意义的相关信息序列。

 FILE - Document，文件和文档是有区别的。

文件名识别文件，扩展名标识文件的特性。

如何从线性编址的存储器中使用目录按名存取的存储结构

#### 优点

方便使用，不需要考虑物理位置，只需要文件名

安全可考，文件系统具有安全保密保护措施，防止被破坏

文件可备份

文件可共享，不同用户进程可以访问统一文件，提高利用率。

#### 文件的使用

open打开，传入文件路径，传回文件描述符。

进程管理：PCB，文件管理：文件控制块，inode

每创建文件，都要创建文件控制块。

inode尺寸相同，按号连续排列，按号定位。找到目录项，从这里找到inode数据结构，inode中记录存储得时候的磁盘物理块

#### 文件物理结构

多重索引结构

教材P316 图6-9 卷结构

线性地址空间实现非线性层次目录结构，达到按名存取的方式

P306 6-2用户与操作系统视角下不同

316 - 317创建和读取的系统调用，对应的参数

文件打开之后，就是留下来的指针域

本质上是路径名定位到目录块，提取目录项，拿到inode数据结构读到主存中。创建文件都需要创建inode数据结构.。系统内部的对用户透明的inode

### 文件存取方法

受限于文件物理结构

索引文件，提供索引和顺序层，模拟直接存取。

对链接文件，索引必须遍历，无法直接存取/索引存取

#### 顺序存取

按照记录顺序读写操作

对各种物理结构都支持

读写指针逐步推进来读写

准许对指针前后跳动

#### 直接存取

很快，任意次序读写某个记录

直接计算在哪个物理块读去

#### 索引存取

基于索引文件的索引表

通过查找记录键计算信息块的物理地址。类似数据库管理系统。

一般这种记录型文件通过DBMS来代替，应用得不多

### 文件的使用

两类接口

* 文件相关操作命令
* 系统调用

#### 文件系统调用

程序级，操作接口

##### 创建文件

创建目录项，分配物理块，在活动文件表中申请一项，等级有关目录信息，返回文件句柄（相关的文件）

之后通过句柄输入信息。

##### 撤销文件

删除

通过文件名和设备号

如果是打开的文件需要先关闭，共享文件要联访处理，可能不是物理上的删除。

##### 打开文件

建立文件和**用户进程**之间的使用联系

查文件目录，把目录信息放到活动文件表

验证文件的权限

##### 关闭文件

结束文件的读写

通过文件句柄

并发控制时，用户数--。

一个进程使用时，推迟写被执行，活动文件表被收回，如果有修改则写回磁盘

##### 读写文件

通过文件句柄、用户数据区地址、字节个数，从逻辑到物理文件的对应

提前读、推迟写

##### 定位文件

### 文件系统调用的实现

#### 文件创建

带路径的文件名和权限

相对路径快一些，必须要从头访问一遍

```C
int fd, mode;
char* name;
fd = create(name, mode);
```

##### 执行过程

1. 分配索引节点和活动索引节点，组成新目录项记录到目录
2. 活动索引节点初值
3. 分配
4. 返回句柄到用户进程

#### 文件删除

unlink(filenamep).

需要具有写权限

如果没有连接用户（i_link == 1），要把物理存储空间释放

#### 文件打开

```C
int fd, mode;
char* name;
fd = open(name, mode);
```

本质上是检索解析路径，定位目录块

名到inode号，检索目录

通过inode号读入inode数据结构

fd最终指向主存活动inode表

主存活动inode表体现文件静态的属性，系统打开文件表体现文件被打开之后实际操作的动态行为和记录

文件打开之后，在系统打开表上有入口地址

#### 文件的关闭

close(fd);

f_count和i_count

进程共享表项/用户进程在使用

系统打开表撤销未必代表主存活动inode的关闭。不同的系统打开文件表指向同一个主存活动表

f_count表示不同进程通过同一个系统打开文件表项共享文件

i_count表示不同进程通过不同系统打开文件表项共享文件

### 文件的共享

#### 静态共享

本质上没有新增加文件，没有增加inode，只在新的目录下加目录项，指向同一个inode

i_nlink++；

文件名可以一样也可以不一样

#### 动态共享

不同用户继承或统一用户的不同进程并发访问同一文件

fork系统调用创建子进程，父进程PCB被赋值，两个表指向同一个索引节点，共享指针

#### 链接共享

不同磁盘分区有相同的inode号，则无法唯一标识

通过软链接进行

符号链接，只有文件名，不指向inode文件，只有文件的拥有者才能有指向inode的指针

### 辅存空间管理

磁盘等辅存空间需要被共享，大量建立和删除文件。大量存储空间的分配和整理

整理碎片，对文件重新组织，让其存于连续存储区中

#### 辅存空间分配

连续分配：顺序访问速度块，管理简单，需要定期整理碎片

非连续分配：有效利用，便于动态增长和收缩

#### 空闲块管理

表格，表示物理块的占用

空闲块成组链接法，用一个空闲块表示空闲块内容，其他指向具体空闲块

### 文件系统实现层次

和设备管理相似，分成多个抽象层次

#### 用户接口

接受用户系统调用，进行语法检查

#### 逻辑文件控制子系统

建立活动文件表，把逻辑记录转换为相对物理块号

#### 文件保护子系统

识别调用者身份，判断文件操作合法性

#### 物理文件控制子系统

缓冲区管理

相对物理块号传为实际物理块号

文件空间的分配

转换为实际IO控制的输入输出

#### IO控制子系统

具体物理块的输入输出